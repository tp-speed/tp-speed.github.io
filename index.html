<!DOCTYPE html>	
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Tehcnopark internet speed</title>
	<script src="/js/global.js"></script>
	<script src="/js/jquery.js"></script>

    <script src="http://www.amcharts.com/lib/3/amcharts.js"></script>
    <script src="http://www.amcharts.com/lib/3/serial.js"></script>
    <script src="http://www.amcharts.com/lib/3/themes/light.js"></script>

	<script src="/js/mongolab.js"></script>
	<script src="/js/api.js"></script>

    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 90%;
        }

        #chartdiv {
            width: 100%; height: 100%; margin: 10px auto;
        }
    </style>
</head>
<body>
	<div id="chartdiv"></div>

	<script>
        var timestampField = 'timestamp';
        var ignoreFields = ['timestamp', 'date', 'size', '_id', 'time'];

        var fieldNames = {
            'speed': "Скорость",
            'pingMin': "Пинг min",
            'pingAvg': "Пинг avg",
            'pingMax': "Пинг max",
            'pingLossPercent': "Потери пакетов"
        };

        var balloons = {
            'speed': "Скорость: <b>[[value]]</b> КБ/с",
            'pingMin': "Пинг min: <b>[[value]]</b> мс",
            'pingAvg': "Пинг avg: <b>[[value]]</b> мс",
            'pingMax': "Пинг max: <b>[[value]]</b> мс",
            'pingLossPercent': "Потери пакетов: <b>[[value]]</b>%"
        };

		api.getData(function(data) {
            if (data.length == 0) {
                return;
            }

            for(var i = 0; i < data.length; ++i) {
                data[i].date = new Date(data[i][timestampField]);
            }

            var fields = Object.getOwnPropertyNames(data[0]);
            var valueAxes = [];
            var graphs = [];

            for(var i = 0; i < fields.length; ++i) {
                var field = fields[i];

                if (ignoreFields.indexOf(field) > -1) {
                    continue;
                }

                valueAxes.push(
                        {
                            "id": field,
                            "axisColor": COLORS[i],
                            "axisThickness": 2
                        }
                );

                graphs.push(
                        {
                            "valueAxis": field,
                            "lineColor": COLORS[i],
                            "bullet": "round",
                            "bulletBorderThickness": 1,
                            "hideBulletsCount": 30,
                            "title": fieldNames[field],
                            "valueField": field,
                            "balloonText": "<div style='margin:5px; font-size:12px;'>" + balloons[field] + "</div>"
                        }
                )
            }

            var chart = AmCharts.makeChart("chartdiv", {
                "type": "serial",
                "theme": "light",
                "dataProvider": data,
                "graphs": graphs,
                "chartScrollbar": {},
                "chartCursor": {
                    "cursorPosition": "mouse"
                },
                "valueAxis": valueAxes,
                "categoryField": "date",
                "legend": {
                    "useGraphSettings": true
                },
                "categoryAxis": {
                    "minPeriod": "mm",
                    "parseDates": true
                },
                "numberFormatter": {
                    "precision": 2
                }
            });
	    });
	</script>
</body>
</html>